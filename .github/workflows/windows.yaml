name: Build and Store Windows Binaries
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          vsversion: 2022
      
      - name: Configure CMake
        run: |
          cmake -S . -B build -G "Ninja" `
                -DCMAKE_TOOLCHAIN_FILE="ci/toolchains/vs-win64.cmake" `
                -DBUILD_METIS=ON `
                -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cmake --build build --config Release --parallel
      
      - name: Install
        run: |
          cmake --install build --prefix install --config Release
      
      - name: Prepare binaries for storage
        run: |
          # Clean old binaries
          Remove-Item -rf binaries 2>$null
          mkdir -p binaries
          
          # Copy built files
          if (Test-Path "install/bin") {
            Copy-Item -Path "install/bin/*" -Destination "binaries/" -Recurse
          }
          if (Test-Path "install/lib") {
            Copy-Item -Path "install/lib/*" -Destination "binaries/" -Recurse
          }
          if (Test-Path "install/include") {
            Copy-Item -Path "install/include/*" -Destination "binaries/" -Recurse
          }
          
          # Add version info
          $date = Get-Date -Format "yyyy-MM-dd"
          "Built: $date" | Out-File -FilePath "binaries/BUILD_INFO.txt"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: suitesparse-windows-binaries
          path: binaries/*
          retention-days: 7
      
      - name: Commit binaries to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add binaries/
          
          # Only commit if there are changes
          if (!(git diff --cached --quiet)) {
            git commit -m "ci: Add Windows binaries [skip ci]"
            git push
          }
