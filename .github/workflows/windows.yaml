name: Build and Store Windows Binaries
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          vsversion: 2022
      
      - name: Configure CMake
        run: |
          cmake -S . -B build -G "Ninja" `
                -DCMAKE_TOOLCHAIN_FILE="ci/toolchains/vs-win64.cmake" `
                -DBUILD_METIS=ON `
                -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cmake --build build --config Release --parallel
      
      - name: Install
        run: |
          cmake --install build --prefix install --config Release
      
      - name: Prepare binaries for storage
        run: |
          # Clean old binaries - PowerShell syntax
          Remove-Item -Path "binaries" -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path "binaries" -Force | Out-Null
          
          # Copy built files
          if (Test-Path "install/bin") {
            Copy-Item -Path "install/bin/*" -Destination "binaries/" -Recurse -Force
          }
          if (Test-Path "install/lib") {
            Copy-Item -Path "install/lib/*" -Destination "binaries/" -Recurse -Force
          }
          if (Test-Path "install/include") {
            Copy-Item -Path "install/include/*" -Destination "binaries/" -Recurse -Force
          }
          
          # Copy CMake config files if they exist
          if (Test-Path "install/lib/cmake") {
            Copy-Item -Path "install/lib/cmake/*" -Destination "binaries/" -Recurse -Force
          }
          
          # Add version info
          $date = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
          $commit = "${{ github.sha }}"
          if ($commit.Length -gt 7) {
            $shortCommit = $commit.Substring(0, 7)
          } else {
            $shortCommit = $commit
          }
          
          @"
SuiteSparse with METIS - Windows Binaries
=========================================
Build Date: $date
Commit: $shortCommit
Full Commit SHA: $commit
GitHub Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
Build Type: Release
Toolchain: Visual Studio 2022 (vs-win64)
METIS: Enabled
"@ | Out-File -FilePath "binaries/README.txt" -Encoding UTF8
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: suitesparse-windows-binaries
          path: binaries/
          retention-days: 7
      
      - name: Commit binaries to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if binaries directory exists and has files
          if (Test-Path "binaries" -PathType Container) {
            $files = Get-ChildItem -Path "binaries" -Recurse -File
            if ($files.Count -gt 0) {
              Write-Host "Found $($files.Count) files in binaries directory"
              git add binaries/
              
              # Check if there are changes
              $status = git status --porcelain
              if ($status) {
                git commit -m "ci: Add Windows binaries for SuiteSparse-METIS [skip ci]

                Built from commit: ${{ github.sha }}
                GitHub Run ID: ${{ github.run_id }}
                Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
                
                # Pull latest changes and push
                git pull --rebase origin ${{ github.ref_name }}
                git push origin HEAD:${{ github.ref_name }}
                Write-Host "Successfully committed and pushed binaries"
              } else {
                Write-Host "No changes to commit"
              }
            } else {
              Write-Host "binaries directory is empty"
            }
          } else {
            Write-Host "binaries directory does not exist"
          }
