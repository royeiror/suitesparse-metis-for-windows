name: Build Windows Binaries
on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch: # Manual trigger
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    name: Build Windows Binaries
    runs-on: windows-latest
    strategy:
      matrix:
        toolchain: [vs-win64, vs-win64-cxx20]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          vsversion: 2022
      
      - name: Configure CMake
        run: |
          cmake -S . -B build -G "Ninja" `
                -DCMAKE_TOOLCHAIN_FILE="ci/toolchains/${{ matrix.toolchain }}.cmake" `
                -DBUILD_METIS=ON `
                -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cmake --build build --config Release --parallel
      
      - name: Create install directory
        run: |
          mkdir -p install/${{ matrix.toolchain }}
          cmake --install build --prefix install/${{ matrix.toolchain }} --config Release
      
      - name: Package binaries
        run: |
          # Create a zip with all built files
          Compress-Archive -Path install/${{ matrix.toolchain }}/* -DestinationPath suitesparse-metis-${{ matrix.toolchain }}-windows.zip -Force
          
          # Also create a simple archive of just the lib and bin directories
          mkdir -p packaged
          Copy-Item -Path install/${{ matrix.toolchain }}/lib/* -Destination packaged/lib/ -Force -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path install/${{ matrix.toolchain }}/bin/* -Destination packaged/bin/ -Force -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path install/${{ matrix.toolchain }}/include/* -Destination packaged/include/ -Force -Recurse -ErrorAction SilentlyContinue
          Compress-Archive -Path packaged/* -DestinationPath suitesparse-metis-${{ matrix.toolchain }}-windows-binaries.zip -Force
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: suitesparse-metis-${{ matrix.toolchain }}
          path: |
            suitesparse-metis-${{ matrix.toolchain }}-windows.zip
            suitesparse-metis-${{ matrix.toolchain }}-windows-binaries.zip
          retention-days: 30
  
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: List downloaded artifacts
        run: ls -R artifacts/
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.zip
          generate_release_notes: true
      
      - name: Upload binaries to release
        run: |
          echo "Release created at: ${{ steps.create_release.outputs.upload_url }}"
  
  store-in-repo:
    name: Store Binaries in Repository
    runs-on: windows-latest
    needs: build-windows
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: downloaded-artifacts
      
      - name: Extract and organize binaries
        run: |
          # Create directory structure
          mkdir -p binaries/windows
          
          # Process each artifact
          $artifacts = Get-ChildItem "downloaded-artifacts" -Directory
          foreach ($artifact in $artifacts) {
            $toolchain = $artifact.Name
            $zips = Get-ChildItem "$artifact/*.zip"
            
            foreach ($zip in $zips) {
              # Extract the binaries zip (not the full install zip)
              if ($zip.Name -like "*binaries.zip") {
                Expand-Archive -Path $zip.FullName -DestinationPath "binaries/windows/$toolchain" -Force
              }
            }
          }
      
      - name: Commit and push binaries
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are changes to commit
          git add binaries/
          
          if (git diff --cached --quiet) {
            echo "No changes to commit"
          } else {
            git commit -m "ci: Add built Windows binaries for SuiteSparse-METIS [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          }
