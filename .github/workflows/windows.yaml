name: Build Windows SuiteSparse-METIS
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        config: [Release]
        toolchain: [vs-win64, vs-win64-cxx20]
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          vsversion: 2022
      
      - name: Configure CMake
        run: |
          cmake -S . -B build-${{ matrix.toolchain }} -G "Ninja" `
                -DCMAKE_TOOLCHAIN_FILE="ci/toolchains/${{ matrix.toolchain }}.cmake" `
                -DBUILD_METIS=ON `
                -DCMAKE_BUILD_TYPE=${{ matrix.config }}
      
      - name: Build
        run: |
          cmake --build build-${{ matrix.toolchain }} --config ${{ matrix.config }} --parallel
      
      - name: Install
        run: |
          cmake --install build-${{ matrix.toolchain }} --prefix install-${{ matrix.toolchain }} --config ${{ matrix.config }}
      
      - name: Upload binaries as artifact
        uses: actions/upload-artifact@v3
        with:
          name: suitesparse-windows-${{ matrix.toolchain }}-${{ matrix.config }}
          path: |
            install-${{ matrix.toolchain }}/bin/
            install-${{ matrix.toolchain }}/lib/
            install-${{ matrix.toolchain }}/include/
          retention-days: 30
  
  deploy:
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Prepare binaries directory
        run: |
          # Create a clean binaries directory
          Remove-Item -Path binaries -Recurse -Force -ErrorAction SilentlyContinue
          mkdir -p binaries/windows
          
          # Copy all downloaded artifacts
          Get-ChildItem artifacts -Directory | ForEach-Object {
            $toolchain = $_.Name -replace 'suitesparse-windows-', '' -replace '-Release', ''
            Copy-Item -Path "$_/*" -Destination "binaries/windows/$toolchain/" -Recurse -Force
          }
      
      - name: Add version info
        run: |
          $date = Get-Date -Format "yyyy-MM-dd"
          $commit = "${{ github.sha }}".Substring(0, 7)
          $versionInfo = @"
Built: $date
Commit: $commit
Toolchains: ${{ join(matrix.toolchain, ', ') }}
Build Type: ${{ join(matrix.config, ', ') }}
"@
          
          $versionInfo | Out-File -FilePath "binaries/VERSION.txt" -Encoding UTF8
      
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          git add binaries/
          
          if (!(git diff --cached --quiet)) {
            git commit -m "ci: Update Windows binaries [skip ci]"
            git push
          }
